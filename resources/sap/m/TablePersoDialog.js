/*
 * SAP UI development toolkit for HTML5 (SAPUI5)
 * 
 * (c) Copyright 2009-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.m.TablePersoDialog");jQuery.sap.require("sap.ui.base.ManagedObject");jQuery.sap.require("sap.m.InputListItem");jQuery.sap.require("sap.m.Switch");jQuery.sap.require("sap.m.SwitchType");jQuery.sap.require("sap.m.Dialog");jQuery.sap.require("sap.m.List");jQuery.sap.require("sap.m.Bar");jQuery.sap.require("sap.m.Button");sap.ui.base.ManagedObject.extend("sap.m.TablePersoDialog",{constructor:function(i,s){sap.ui.base.ManagedObject.apply(this,arguments)},metadata:{properties:{"contentWidth":{type:"sap.ui.core.CSSSize"},"contentHeight":{type:"sap.ui.core.CSSSize",since:"1.22"},"persoMap":{type:"object"},"columnInfoCallback":{type:"object",since:"1.22"},"initialColumnState":{type:"object",since:"1.22"},"hasGrouping":{type:"boolean",since:"1.22"},"showSelectAll":{type:"boolean",since:"1.22"},"showResetAll":{type:"boolean",since:"1.22"},},aggregations:{"persoService":{type:"Object",multiple:false}},associations:{"persoDialogFor":sap.m.Table},events:{confirm:{},cancel:{}},library:"sap.m"}});
sap.m.TablePersoDialog.prototype.init=function(){var t=this,l=0;this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oP13nModel=new sap.ui.model.json.JSONModel();this._fnUpdateCheckBoxes=jQuery.proxy(function(e){var s=e.getParameter('selected'),d=this._oP13nModel.getData();if(e.getSource().getParent().getParent()==this._oSelectAllHeader){d.aColumns.forEach(function(c){c.visible=s})}else{var S=!d.aColumns.some(function(c){return!c.visible});d.aHeaders[0].visible=S}this._oP13nModel.setData(d)},this);this._oColumnItemTemplate=new sap.m.InputListItem({label:"{Personalization>text}",content:new sap.m.CheckBox({selected:"{Personalization>visible}",select:this._fnUpdateCheckBoxes}),}).addStyleClass("sapMPersoDialogLI");this._oHeaderItemTemplate=new sap.m.InputListItem({label:"{Personalization>text}",content:new sap.m.CheckBox({selected:"{Personalization>visible}",select:this._fnUpdateCheckBoxes}),}).addStyleClass("sapMPersoDialogLI").addStyleClass("sapMPersoDialogLIHeader");this._oButtonUp=new sap.m.Button({icon:"sap-icon://arrow-top",enabled:false,press:function(e){t._moveItem(-1)}});this._oButtonDown=new sap.m.Button({icon:"sap-icon://arrow-bottom",enabled:false,press:function(e){t._moveItem(1)}});this._fnHandleResize=function(){var $=jQuery("#"+t._oDialog.getId()+"-cont");if($.children().length>0&&t._oSelectAllHeader.$().length>0){var c=$.children()[0].clientHeight;var h=t.getShowSelectAll()?t._oSelectAllHeader.$()[0].clientHeight:0;t._oScrollContainer.setHeight((c-h)+'px')}};this._fnUpdateArrowButtons=function(){var b=true,B=true,v=t._oSearchField.getValue(),i=t._oList.getItems().length;if(!!v||t._oList.getSelectedItems().length===0){B=false;b=false}else{if(t._oList.getItems()[0].getSelected()){B=false};if(t._oList.getItems()[i-1].getSelected()){b=false}}t._oButtonUp.setEnabled(B);t._oButtonDown.setEnabled(b)};this._fnAfterListRendering=function(e){var I=e.srcControl.$().find('.sapMCb'),a=I.length;for(var i=0;i<a;i++){var $=jQuery(I[i]).parent(),s=$.siblings(),b=s.length==1?jQuery(s[0]):null;if(b){$=$.detach();$[0].className='sapMLIBSelectM';$.insertBefore(b)}}};this._oList=new sap.m.List({includeItemInSelection:true,noDataText:this._oRb.getText('PERSODIALOG_NO_DATA'),mode:sap.m.ListMode.SingleSelectMaster,select:this._fnUpdateArrowButtons,});this._oSelectAllHeader=new sap.m.List({includeItemInSelection:true,mode:sap.m.ListMode.None,});this._oList.addDelegate({onAfterRendering:this._fnAfterListRendering});this._oSelectAllHeader.addDelegate({onAfterRendering:this._fnAfterListRendering});this._oSearchField=new sap.m.SearchField(this.getId()+"-searchField",{width:"100%",liveChange:function(e){var v=e.getSource().getValue(),d=(v?300:0);clearTimeout(l);if(d){l=setTimeout(function(){t._executeSearch()},d)}else{t._executeSearch()}},search:function(e){t._executeSearch()}});this._oScrollContainer=new sap.m.ScrollContainer({horizontal:false,vertical:true,content:[this._oList],width:'100%',});this._oDialog=new sap.m.Dialog({title:this._oRb.getText("PERSODIALOG_COLUMNS_TITLE"),stretch:sap.ui.Device.system.phone,horizontalScrolling:false,verticalScrolling:false,content:[this._oSelectAllHeader,this._oScrollContainer],subHeader:new sap.m.Bar({contentLeft:[this._oButtonUp,this._oButtonDown],contentMiddle:this._oSearchField}),leftButton:new sap.m.Button({text:this._oRb.getText("PERSODIALOG_OK"),press:function(){t._oDialog.close();sap.ui.Device.resize.detachHandler(t._fnHandleResize);t.fireConfirm()}}),rightButton:new sap.m.Button({text:this._oRb.getText("PERSODIALOG_CANCEL"),press:function(){t._oDialog.close();sap.ui.Device.resize.detachHandler(t._fnHandleResize);t.fireCancel()}})}).addStyleClass("sapMPersoDialog");this._resetAllButton=new sap.m.Button({icon:"sap-icon://refresh",press:function(){t._resetAll()}});this._oDialog._header.addContentRight(this._resetAllButton)};
sap.m.TablePersoDialog.prototype.retrievePersonalizations=function(){return this._oP13nModel.getData()};
sap.m.TablePersoDialog.prototype.open=function(){var s=null;if(this.getHasGrouping()){s=[new sap.ui.model.Sorter('group',false,true)]}this._readCurrentSettingsFromTable();this._oDialog.setModel(this._oP13nModel,"Personalization");this._oList.bindAggregation("items",{path:"Personalization>/aColumns",sorter:s,template:this._oColumnItemTemplate});this._oSelectAllHeader.bindAggregation("items",{path:"Personalization>/aHeaders",template:this._oHeaderItemTemplate});this._fnUpdateArrowButtons.call(this);this._oDialog.open();this._fnHandleResize.call(this);sap.ui.Device.resize.attachHandler(this._fnHandleResize)};
sap.m.TablePersoDialog.prototype.setContentHeight=function(h){this.setProperty("contentHeight",h,true);this._oDialog.setContentHeight(h);return this};
sap.m.TablePersoDialog.prototype.setContentWidth=function(w){this.setProperty("contentWidth",w,true);this._oDialog.setContentWidth(w);return this};
sap.m.TablePersoDialog.prototype.exit=function(){this._oRb=null;this._oP13nModel=null;if(this._oColumnItemTemplate){this._oColumnItemTemplate.destroy();this._oColumnItemTemplate=null}if(this._oHeaderItemTemplate){this._oHeaderItemTemplate.destroy();this._oHeaderItemTemplate=null}if(this._oSelectAllHeader){this._oSelectAllHeader.destroy();this._oSelectAllHeader=null}if(this._oList){this._oList.destroy();this._oList=null}if(this._oSearchField){this._oSearchField.destroy();this._oSearchField=null}if(this._oScrollContainer){this._oScrollContainer.destroy();this._oScrollContainer=null}if(this._oDialog){this._oDialog.destroy();this._oDialog=null}if(this._oButtonDown){this._oButtonDown.destroy();this._oButtonDown=null}if(this._oButtonUp){this._oButtonUp.destroy();this._oButtonUp=null}};
sap.m.TablePersoDialog.prototype._resetAll=function(){if(this.getInitialColumnState()){this._oP13nModel.setData({aColumns:this.getInitialColumnState(),aHeaders:[{text:this._oRb.getText("PERSODIALOG_SELECT_ALL"),visible:!this.getInitialColumnState().some(function(c){return!c.visible}),id:this.getId()+'_SelectAll'}]})}};
sap.m.TablePersoDialog.prototype._tableColumnInfo=function(t){if(!!this.getPersoMap()){var c=t.getColumns(),d=this,C=[];c.forEach(function(o){var s=null;if(d.getPersoService().getCaption){s=d.getPersoService().getCaption(o)}var g=null;if(d.getPersoService().getGroup){g=d.getPersoService().getGroup(o)}if(!s){var a=o.getHeader();if(a.getText&&a.getText()){s=a.getText()}else if(a.getTitle&&a.getTitle()){s=a.getTitle()}}if(!s){s=o.getId();jQuery.sap.log.warning("Please 'getCaption' callback implentation in your TablePersoProvider for column "+o+". Table personalization uses column id as fallback value.")}C.push({text:s,order:o.getOrder(),visible:o.getVisible(),id:d.getPersoMap()[o],group:g})});C.sort(function(a,b){return a.order-b.order});return C}return null};
sap.m.TablePersoDialog.prototype._moveItem=function(d){var m=this._oP13nModel;var s=this._oList.getSelectedItem();if(!s)return;var a=m.getData();var i=s.getBindingContext("Personalization").getPath().split("/").pop()*1;var b=i+d;if(b<0||b>=a.aColumns.length)return;var t=a.aColumns[b];a.aColumns[b]=a.aColumns[i];a.aColumns[b].order=b;a.aColumns[i]=t;a.aColumns[i].order=i;this._oList.removeSelections(true);this._swapListItemContent(this._oList,i,b);this._oList.setSelectedItem(this._oList.getItems()[b],true);this._fnUpdateArrowButtons.call(this)};
sap.m.TablePersoDialog.prototype._swapListItemContent=function(l,i,s){var L=l.getItems();var a="#"+L[i].getId()+" label",b="#"+L[s].getId()+" label";var c=jQuery(b).html();var S="#"+L[i].getContent()[0].getId();var d="#"+L[s].getContent()[0].getId();var e=jQuery(d).html();jQuery(b).html(jQuery(a).html());jQuery(a).html(c);jQuery(d).html(jQuery(S).html());jQuery(S).html(e)};
sap.m.TablePersoDialog.prototype._readCurrentSettingsFromTable=function(){var t=sap.ui.getCore().byId(this.getPersoDialogFor()),c=this.getColumnInfoCallback().call(this,t,this.getPersoMap(),this.getPersoService());this._oP13nModel.setData({aColumns:c,aHeaders:[{text:this._oRb.getText("PERSODIALOG_SELECT_ALL"),visible:!c.some(function(C){return!C.visible}),id:this.getId()+'_SelectAll'}]})};
sap.m.TablePersoDialog.prototype._executeSearch=function(){var v=this._oSearchField.getValue(),f=new sap.ui.model.Filter("text",sap.ui.model.FilterOperator.Contains,v),b=this._oList.getBinding("items");this._oSelectAllHeader.setVisible(!v&&this.getShowSelectAll());b.filter([f]);this._fnUpdateArrowButtons.call(this);return this};
sap.m.TablePersoDialog.prototype.setHasGrouping=function(h){this.setProperty("hasGrouping",h,true);var b=this._oDialog.getSubHeader();if(!h){if(b.getContentLeft().length==0){b.addContentLeft(this._oButtonUp);b.addContentLeft(this._oButtonDown)}}else{b.removeAllContentLeft()}return this};
sap.m.TablePersoDialog.prototype.setShowSelectAll=function(s){this.setProperty("showSelectAll",s,true);this._oSelectAllHeader.setVisible(s);this._fnHandleResize.call(this);return this};
sap.m.TablePersoDialog.prototype.setShowResetAll=function(s){this.setProperty("showResetAll",s,true);this._resetAllButton.setVisible(s);return this};
