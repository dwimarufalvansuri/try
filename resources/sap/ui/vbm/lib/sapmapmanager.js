 
function UnlinkImage(i){for(var a=i.m_Prev;a;a=a.m_Prev){a.m_bOutdated=true}for(var a=i.m_Next;a;a=a.m_Next){a.m_bOutdated=true}var c=i.m_Prev;var b=i.m_Next;if(c!=null){i.m_Prev.m_Next=b;i.m_Prev=null}if(b!=null){i.m_Next.m_Prev=c;i.m_Next=null}}
VBI.MapManager=(function(){var m={};m.vbiclass="MapManager";m.m_nRequest=0;m.m_tileWidth=256;m.m_tileHeight=256;m.onAbort=function(e){var i=e.srcElement;VBI.m_bTrace&&VBI.Trace("onAbort "+i.src);UnlinkImage(i);m.CheckTmpCanvas(i.m_Target,i.m_nRequest,i.m_nLayersAbove)};m.onError=function(e){var i=e.srcElement;var a=null;VBI.m_bTrace&&VBI.Trace("onError "+i.src);if(i.m_Next!=null)i.m_Next.m_FillStyle=i.m_FillStyle;if(i.m_Prev==null&&i.m_Next!=null&&i.m_Next.complete==true)a=i.m_Next;UnlinkImage(i);if(a!=null)m.RenderTile(a);else{m.CheckTmpCanvas(i.m_Target,i.m_nRequest,i.m_nLayersAbove)}};m.onLoad=function(e){var i=e.srcElement||e.target;VBI.m_bTrace&&VBI.Trace("VBI.MapManager: onLoad  "+i.src);var c=true;for(var a=i.m_Prev;a!=null;a=a.m_Prev)c&=a.complete;for(var a=i.m_Next;a!=null;a=a.m_Next)c&=a.complete;if(!c){VBI.m_bTrace&&VBI.Trace("VBI.MapManager: onLoad skip due there is a a not yet loaded tile ");return}m.RenderTile(i)};m.RenderTile=function(i){var t=i.m_Target;if((t.m_CanvasRedirect!=undefined)&&(t.m_CanvasRedirRequest==i.m_nRequest))t=t.m_CanvasRedirect;var c=t.m_Scene;if(!c)return;var a=t.getPixelWidth();var b=t.getPixelHeight();t.m_nAppliedRequest=Math.max(t.m_nAppliedRequest,i.m_nRequest);var d=t.getContext('2d');var n=(1<<d.canvas.m_nCurrentLOD);var e=((i.m_nReqX-d.canvas.m_nCurrentX)%n+n)%n;if(n<c.m_nTilesX)e=i.m_nCol+i.m_nXOrigin-d.canvas.m_nCurrentX;var f=i.m_nReqY-d.canvas.m_nCurrentY;if(i.m_bOutdated||(e<0)||(f<0)||(e>=i.m_numCol)||(f>=i.m_numRow)||(i.m_nLOD!=d.canvas.m_nCurrentLOD||t.m_bInvalid)){UnlinkImage(i);VBI.m_bTrace&&VBI.Trace("VBI.MapManager: RenderTile  "+i.src+" is outdated");m.CheckTmpCanvas(t,i.m_nRequest,i.m_nLayersAbove);return}VBI.m_bTrace&&VBI.Trace("VBI.MapManager: RenderTile  "+i.src);var g=c.m_nWidthCanvas;var h=c.m_nHeightCanvas;t.setPixelWidth(g);t.setPixelHeight(h);var j=g/c.m_nTilesX;var k=h/c.m_nTilesY;var l=e*j;var o=f*k;var p=i.m_nXExpansion*j;var q=i.m_nYExpansion*k;var r=i;while(r.m_Prev!=null)r=r.m_Prev;while(r!=null&&r.complete==true){r.onload=null;r.onabort=null;r.onerror=null;if(r.m_FillStyle!=null){VBI.m_bTrace&&VBI.Trace("RenderTile fillRect "+r.src);var s=d.fillStyle;d.fillStyle=r.m_FillStyle;d.fillRect(l,o,p,q);d.fillStyle=s}VBI.m_bTrace&&VBI.Trace("RenderTile drawImage "+r.src);d.globalAlpha=r.m_Opacity;d.drawImage(r,l,o,p,q);if(r.m_Next!=null)r.m_Next.m_Prev=null;r=r.m_Next}if(VBI.m_bTrace){var s=d.fillStyle;d.fillStyle="#FF0000";d.font="18px Arial";d.fillText(i.m_nRequest+"."+i.m_nCount+":"+i.m_nLOD+"/"+i.m_nReqX+"/"+i.m_nReqY+"@("+(l/256)+","+(o/256)+")",l+10,o+30);d.fillStyle=s}t.setPixelWidth(a);t.setPixelHeight(b);if(t.onTileLoaded)t.onTileLoaded(i);d.globalAlpha=1.0;m.CheckTmpCanvas(t,i.m_nRequest,0)};m.CheckTmpCanvas=function(t,i,n){if((t.m_nTilesBefSwitch!=undefined)&&(t.m_nRequest==i)&&!n){t.m_nTilesBefSwitch--;if(!t.m_nTilesBefSwitch)t.m_Scene.SwitchTmpCanvasToActive()}};m.RequestTiles=function(t,a,x,y,n,b,l,c,r,d,e,f){if(e<0)return;var g=t.m_Scene;if(!a||((g.AnimZoomTarget)&&(Math.abs(g.AnimZoomTarget-e)>g.m_nMaxAnimLodDiff))){t.m_nCurrentX=x;t.m_nCurrentY=y;t.m_nCurrentLOD=e;return}var h=0;var j=(1<<e);var o=g.m_Proj.m_nXYRatio;var p=j*o;var T=2.0/j;if(f){var q=t.getContext("2d");q.fillStyle='white';q.clearRect(0,0,q.canvas.width,q.canvas.height)}var u=a.m_MapLayerArray;t.m_nRequest=m.m_nRequest++;t.m_bInvalid=false;t.m_nCurrentX=x;t.m_nCurrentY=y;t.m_nCurrentLOD=e;var v,w,z,A=1;var B=y;if(a.m_bSingleBMP){w=1;B=Math.max(0,y);z=Math.min(b-c-d,j-B)}else{w=b-c-d;z=1}var C=u.length;v=n-l-r;for(var i=0;i<v;++i){A--;if(!A){for(var k=0;k<w;++k){h++;var D=null;var E=null;var F=(x+l+i)%p;if(F<0)F=p+F;var G=B+c+k;if((G+z)<=0||G>=j)continue;A=a.m_bSingleBMP?Math.min(p-F,v-i):1;for(var s=0;s<C;++s){var H=u[s];if(H.fillStyle)E=H.fillStyle;if(H.GetMinLOD()>e)continue;if(H.GetMaxLOD()<e)continue;var I=new Image();I.m_nLayersAbove=C-s-1;I.m_nXOrigin=x;I.m_nYOrigin=y;I.m_nCol=i+l;I.m_nRow=k+c;I.m_numCol=n;I.m_numRow=b;I.m_Target=t;I.m_nRequest=t.m_nRequest;I.m_Opacity=H.m_fOpacity;I.m_bOutdated=false;I.m_Prev=D;if(D!=null)D.m_Next=I;if(I.m_Prev==null)I.m_FillStyle=E;I.m_nReqX=F;I.m_nReqY=G;I.m_nXExpansion=A;I.m_nYExpansion=z;I.m_nLOD=e;var J=H.GetMapProvider();var K;if(J.m_bPosRequired){var L=[F*T/o-1,G*T-1];var M=[(F+A)*T/o-1,(G+z)*T-1];K=J.CombineUrlWPos(F,G,e,T,L,M,A,z,m.m_requestTileWidth,m.m_requestTileHeight)}else{K=J.CombineUrl(F,G,e)}I.onload=m.onLoad;I.onabort=m.onAbort;I.onerror=m.onError;I.src=K;I.m_nCount=h;VBI.m_bTrace&&VBI.Trace("RequestTiles "+K);D=I}}}}};return m})();
