 VBI.InputModeDefault=0;VBI.InputModeTrackObject=1;VBI.InputModeTrackMap=2;VBI.InputModeTrackDesign=3;VBI.InputModeRectSelect=4;
VBI.SceneManager=function(){var s={};s.vbiclass="SceneManager";s.m_SceneArray=[];s.find=function(n){for(var a=0;a<s.m_SceneArray.length;++a)if(s.m_SceneArray[a].m_ID==n)return s.m_SceneArray[a];return null};s.clear=function(){for(var n=0;n<s.m_SceneArray.length;++n)s.m_SceneArray[n].clear();s.m_SceneArray=[]};s.load=function(d,c){if(d.Set){var a;if(jQuery.type(d.Set)=='object'){if(d.Set.name){if(a=s.find(d.Set.name)){a.clear();if(d.Set.SceneGeo)a.load(d.Set.SceneGeo,c);else a.load(d.Set.Scene,c);return}}else{s.clear()}if(d.Set.SceneGeo){if(jQuery.type(d.Set.SceneGeo)=='object'){var a=new VBI.GeoScene(null,null,null);a.load(d.Set.SceneGeo,c);s.Add(a)}else if(jQuery.type(d.Set.SceneGeo)=='array'){for(var n=0;n<d.Set.SceneGeo.length;++n){var a=new VBI.GeoScene(null,null,null);a.load(d.Set.SceneGeo[n],c);s.Add(a)}}}else if(d.Set.Scene&&jQuery.type(d.Set.Scene)=='object'){if(jQuery.type(d.Set.Scene)=='object'){var a=new VBI.Scene(null,null,null);a.load(d.Set.Scene,c);s.Add(a)}else if(jQuery.type(d.Set.Scene)=='array'){for(var n=0;n<d.Set.Scene.length;++n){var a=new VBI.Scene(null,null,null);a.load(d.Set.Scene[n],c);s.Add(a)}}}}else if(jQuery.type(d.Set)=='array'){}}};s.Add=function(a){s.m_SceneArray.push(a)};s.GetScene=function(t){for(var i=0;i<s.m_SceneArray.length;++i){if(s.m_SceneArray[i].m_TargetName==t)return s.m_SceneArray[i]}return null};s.GetSceneByName=function(n){for(var i=0;i<s.m_SceneArray.length;++i){if(s.m_SceneArray[i].m_ID==n)return s.m_SceneArray[i]}return null};return s};
VBI.Scene=function(t){var s={};s.vbiclass="Scene";s.m_TargetName=t;s.m_ID="";s.m_Ctx=null;s.m_Div=null;s.m_CaptureVO=null;s.m_DesignVO=null;s.m_VOS=[];s.m_Events=null;s.m_Proj=null;s.m_LastDefinedCenterPos=s.m_LastZoomArea=undefined;s.m_HotItem={m_VO:null,m_Index:null,m_Design:null,m_HitObj:null};s.m_Target=t;s.BaseLoad=function(d,c){VBI.RegisterKeyboardHook();s.m_Ctx=c;if(d.id)s.m_ID=d.id;if(d.VO){var v=new VBI.VisualObjects();if(jQuery.type(d.VO)=='object'){var a=v.Factory.CreateInstance(d.VO.type);a.m_Scene=s;a.load(d.VO,c);s.m_VOS.push(a)}else if(jQuery.type(d.VO)=='array'){for(var n=0;n<d.VO.length;++n){if(jQuery.type(d.VO[n])=='object'){var a=v.Factory.CreateInstance(d.VO[n].type);a.m_Scene=s;a.load(d.VO[n],c);s.m_VOS.push(a)}}}}};s.BaseClear=function(){for(var n=0,a=s.m_VOS.length;n<a;++n)s.m_VOS[n].clear();s.m_VOS=[];s.m_Div=null;s.m_Ctx=null;s.m_CaptureVO=null;s.m_DesignVO=null;s.m_HotItem=null;if(s.m_Events){s.m_Events.clear();s.m_Events=null}VBI.UnRegisterKeyboardHook()};s.BaseGetVO=function(i){for(var n=0,a=s.m_VOS.length;n<a;++n)if(s.m_VOS[n].m_ID==i)return s.m_VOS[n];return null};s.load=function(d,c){s.BaseLoad(d,c)};s.clear=function(){s.BaseClear()};s.InternalSetHotItem=function(v,h){var a=s.m_HotItem;var m=false;if(h&&(a.m_Index!=h.m_Index)){a.m_Index=h.m_Index;m=true}if(h&&(a.m_Design!=h.m_Design)){a.m_Design=h.m_Design;m=true}if(a.m_VO!=v){a.m_VO=v;m=true}var b;if(h&&(b=a.m_HitObj)){if(!jQuery.sap.equal(b,h,1))m=true}else if(h==null&&a.m_HitObj==null){}else{m=true}a.m_HitObj=h;if(m)s.RenderAsync()};s.InternalRenderVisualObjects=function(c,a){var v=s.m_VOS;for(var n=0;n<s.m_VOS.length;++n)v[n].Render(c,a)};s.Render=function(){};s.Awake=function(t){s.InternalRenderVisualObjects(null,s.m_Ctx)};s.NotifyDataChange=function(){for(var n=0;n<s.m_VOS.length;++n)s.m_VOS[n].NotifyDataChange(s.m_Ctx)};s.GetPointArrayFromPosArray=function(p,a){return p};s.GetPosFromPoint=function(p){return p};s.GetPointFromPos=function(p,a){return s.GetPointArrayFromPosArray(p,a)};s.GetEventVPCoords=function(e){var r=s.m_Div.getBoundingClientRect();return[e.clientX-r.left,e.clientY-r.top]};s.GetEventVPCoordsObj=function(e){var p=s.GetEventVPCoords(e);return{x:p[0].toString(),y:p[1].toString()}};s.SetCapture=function(v){m_CaptureVO=v};s.DispatchEvent=function(e,a){VBI.m_bTrace&&VBI.Trace("DispatchEvent "+e.type+" as "+a+" mode:"+s.m_nInputMode+(s.m_Gesture?" gesture active":""));if(s.m_nInputMode==VBI.InputModeTrackMap)return false;var f,b=e.type;if(a)e.m_evName=b=a;e.m_Scene=s;if(e.offsetX==undefined||e.offsetY==undefined){var r;if(e.clientX!==undefined&&e.clientY!==undefined){r=e.target.getBoundingClientRect();e.offsetX=e.clientX-r.left;e.offsetY=e.clientY-r.top}else if(e.changedTouches!==undefined&&(e.changedTouches.length>0)){r=e.target.getBoundingClientRect();e.clientX=e.changedTouches[0].clientX;e.clientY=e.changedTouches[0].clientY;e.offsetX=e.clientX-r.left;e.offsetY=e.clientY-r.top}}if(e.shiftKey==undefined)e.shiftKey=VBI.m_shiftKey;if(e.ctrlKey==undefined)e.ctrlKey=VBI.m_ctrlKey;if(s.m_DesignVO){VBI.m_bTrace&&VBI.Trace("DispatchEvent to Design VO");if((f=s.m_DesignVO["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_DesignVO))(e)==true)return true}}if(s.m_CaptureVO){if((f=s.m_CaptureVO["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_CaptureVO))(e)==true)return true}}var i;for(var n=0,l=s.m_VOS.length;n<l;++n){i=l-n-1;if((f=s.m_VOS[i]["on"+b])&&typeof(f)=='function'){if((f.bind(s.m_VOS[i]))(e)==true)return true}}return false};return s};
VBI.GeoScene=function(t,m,c){var s=new VBI.Scene(t);s.vbiclass="GeoScene";s.m_RefMapLayerStack="";s.m_DivCopyright=null;s.m_Canvas=[];s.m_ZoomFactors=[1.0,1.0];s.m_MapManager=m;s.m_MapLayerStack=c;s.m_nMaxCanvasDimension=8192;if(VBI.m_bIsMobile)s.m_nMaxCanvasDimension=6144;s.Click=null;s.m_nOverlayIndex=2;s.m_nTapCount=0;s.GetHomeLocation=null;s.m_Touches=[];s.m_currentMouseX=0;s.m_currentMouseY=0;s.m_oldMouseX=0;s.m_oldMouseY=0;s.m_currentMouseDownX=0;s.m_currentTouchCount=0;s.m_currentMouseDownY=0;s.m_midPointX=0;s.m_midPointY=0;s.m_currentTouchDistance=0;s.m_nInputMode=VBI.InputModeDefault;s.m_BlendTimer=null;s.m_AnimZoomTimer=null;s.m_startPointLonLat=[0.0,0.0];s.m_startLOD=0;s.m_bNavControlVisible=true;s.m_NavControl=null;s.m_RenderTimer=null;s.m_SuppressedNavigation={zoom:false,move:false};s.m_bScaleVisible=true;s.m_OverlayImageData=null;s.m_nCanvasXOversize=2.2;s.m_nCanvasYOversize=2.2;s.m_nCanvasStdXPos=s.m_nCanvasXOversize/4;s.m_nCanvasStdYPos=s.m_nCanvasYOversize/4;s.m_nTicksInALod=5;s.m_nLodFactorZoomIn=Math.pow(2,1/s.m_nTicksInALod);s.m_nLodFactorZoomOut=1/s.m_nLodFactorZoomIn;s.m_nLodFactorZoomInHalf=Math.pow(2,1/(2*s.m_nTicksInALod));s.m_nLodFactorZoomOutHalf=1/s.m_nLodFactorZoomInHalf;s.m_nMaxAnimLodDiff=3;s.m_nZoomMode=1;s.onTileLoaded=null;s.clear=function(){s.BaseClear();s.m_Touches=[];if(s.m_NavControl){s.m_NavControl.clear();s.m_NavControl=null}if(s.m_Scale){s.m_Scale.clear();s.m_Scale=null}s.clearTimers();s.clearCanvases();s.SetInputMode(VBI.InputModeDefault);s.Remove();s.m_RefMapLayerStack="";s.m_MapManager=null;s.m_MapLayerStack=null;s.m_TargetName=null;s.m_OverlayImageData=null;s.m_Proj=null;s.m_DivCopyright=null;s.m_Target=null};s.load=function(d,a){s.BaseLoad(d,a);if(d.refMapLayerStack)s.m_RefMapLayerStack=a.m_MapLayerStackManager.GetMapLayerStack(d.refMapLayerStack);else VBI.m_bTrace&&VBI.Trace("no map layer specified in geo scene");var b=-1000,e=1000;var f=-90,g=90;s.m_nMinLodVisualBorder=0;s.m_nMaxLodVisualBorder=99;s.m_nOffsetMinLod=2;s.m_bYBorderExists=false;if(d.VisualFrame){if(d.VisualFrame.minX!=undefined)b=d.VisualFrame.minX;if(d.VisualFrame.maxX!=undefined)e=d.VisualFrame.maxX;if(d.VisualFrame.minY!=undefined)f=d.VisualFrame.minY;if(d.VisualFrame.maxY!=undefined)g=d.VisualFrame.maxY;if(d.VisualFrame.minY!=undefined||d.VisualFrame.maxY!=undefined)s.m_bYBorderExist=true;if(d.VisualFrame.minLOD!=undefined)s.m_nMinLodVisualBorder=d.VisualFrame.minLOD;if(d.VisualFrame.maxLOD!=undefined)s.m_nMaxLodVisualBorder=d.VisualFrame.maxLOD;if(d.VisualFrame.offsetMinLOD!=undefined)s.m_nOffsetMinLod=d.VisualFrame.offsetMinLOD}s.m_bXBorderExists=(b!=-1000)||(e!=1000);s.m_nBorderMinPoint=VBI.MathLib.DegToRad([b,g]);s.m_nBorderMaxPoint=VBI.MathLib.DegToRad([e,f]);s.m_Proj=s.setProjection();var u=[1.0,1.0],h=[1.0,1.0];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,u);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,h);s.m_nXSizeVisualBorder=Math.max(0.0,Math.min(1.0,h[0]-u[0]));s.m_nYSizeVisualBorder=Math.max(0.0,Math.min(1.0,h[1]-u[1]));if(d.initialStartPosition){var i=d.initialStartPosition.split(';');s.m_startPointLonLat=VBI.MathLib.DegToRad([parseFloat(i[0]),parseFloat(i[1])])}if(d.initialZoom){s.m_startLOD=parseInt(d.initialZoom)}var S={zoom:false,move:false,fade:false};if(d.NavigationDisablement){if(d.NavigationDisablement.zoom)s.m_SuppressedNavigation.zoom=VBI.Types.string2bool(d.NavigationDisablement.zoom);if(d.NavigationDisablement.move)s.m_SuppressedNavigation.move=VBI.Types.string2bool(d.NavigationDisablement.move)}if(d.navControlVisible)s.m_bNavControlVisible=VBI.Types.string2bool(d.navControlVisible);S.zoom=s.m_SuppressedNavigation.zoom;S.move=s.m_SuppressedNavigation.move;if(s.m_SuppressedNavigation.zoom&&s.m_SuppressedNavigation.move)s.m_bNavControlVisible=false;else{if(s.m_bNavControlVisible){if(d.SuppressedNavControlVisibility){if(!S.zoom&&d.SuppressedNavControlVisibility.zoom)S.zoom=VBI.Types.string2bool(d.SuppressedNavControlVisibility.zoom);if(!S.move&&d.SuppressedNavControlVisibility.move)S.move=VBI.Types.string2bool(d.SuppressedNavControlVisibility.move);if(d.SuppressedNavControlVisibility.fade)S.fade=VBI.Types.string2bool(d.SuppressedNavControlVisibility.fade)}if(S.move&&S.zoom)s.m_bNavControlVisible=false}}if(s.m_bNavControlVisible)s.m_NavControl=new VBI.NavigationControl(S);if(d.scaleVisible)s.m_bScaleVisible=VBI.Types.string2bool(d.scaleVisible);if(s.m_bScaleVisible)s.m_Scale=new VBI.Scale(s)};s.SetInputMode=function(v){VBI.m_bTrace&&VBI.Trace("SetInputMode: "+this.m_nInputMode);if(this.m_nInputMode==v)return;switch(this.m_nInputMode){case VBI.InputModeTrackMap:s.SetInputModeTrackMap(false);break};switch(v){case VBI.InputModeTrackMap:s.SetInputModeTrackMap(true);break}this.m_nInputMode=v};s.SetToolTip=function(a){var C=s.m_Canvas[s.m_nOverlayIndex];if(C.title!=a)C.title=a};s.SetCursor=function(a){var C=s.m_Canvas[s.m_nOverlayIndex];if(C.style.cursor!=a)C.style.cursor=a};s.RenderAsync=function(){if(s.m_RenderTimer)return;s.m_RenderTimer=window.setInterval(s.Render,20)};s.Render=function(){if(s.m_RenderTimer){window.clearInterval(s.m_RenderTimer);s.m_RenderTimer=null}if(s.m_Canvas.length)s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false)};s.GoToInitialStart=function(){if(!s.ZoomToGeoPosition(s.m_startPointLonLat,s.m_startLOD,true)){var a=VBI.MathLib.RadToDeg(s.m_nBorderMinPoint);var b=VBI.MathLib.RadToDeg(s.m_nBorderMaxPoint);var l=[a[0],b[0]];var d=[a[1],b[1]];s.ZoomToMultiplePositions(l,d,1.1)}};s.ZoomToMultiplePositions=function(l,d,e){var f=[];var g=[];if(l.length!=d.length)return;for(var n=0;n<l.length;n++){var L=(parseFloat(l[n]));if(L<0)L+=360;f.push(L);g.push(parseFloat(d[n]))}if(f.length!=g.length||!f.length)return;f.sort(function(a,b){return a-b});g.sort(function(a,b){return a-b});var h=0,i=0,j,k;j=g[0];k=g[g.length-1];var o=undefined,p,q,r;p=f[f.length-1];for(var n=0;n<f.length;n++){q=f[n];r=(q<p?(q+360-p):(q-p));if(o==undefined||r>o){o=r;h=(q<p?q+360:q);i=p}p=q}s.ZoomToArea(h,i,j,k,e?e:0.9)};s.ZoomToArea=function(a,b,d,e,f){var n=256,g=256;if(s.m_MapManager){n=s.m_MapManager.m_tileWidth;nTileHeigth=s.m_MapManager.m_tileHeight}var h=s.m_nDivHeight?s.m_nDivHeight:g;var i=s.m_nDivWidth?s.m_nDivWidth:n;if(b<a)b+=360;var z=b/2+a/2;while(z>180)z-=360;var j=e/2+d/2;var l=14;var k=14;while(a>180)a-=360;while(b>180)b-=360;var o=[a,d];var p=[b,e];o=VBI.MathLib.DegToRad(o);p=VBI.MathLib.DegToRad(p);var u=[n,g];var q=[n,g];s.m_Proj.LonLatToUCS(o,u);s.m_Proj.LonLatToUCS(p,q);if(e!=d){l=f*h/(Math.abs(q[1]-u[1]));l=Math.log(l)*Math.LOG2E}if(b!=a){k=f*i/(Math.abs(q[0]-u[0]));k=Math.log(k)*Math.LOG2E}var r=(f>1.0)?Math.max(k,l):Math.min(k,l);var v=VBI.MathLib.DegToRad([z,j]);s.ZoomToGeoPosition(v,r);if(r!=Math.floor(r)){setTimeout(function(){s.AnimateZoomToGeo(v,Math.floor(r),40)},600)}var w=new Date().getTime();s.m_LastZoomArea=[w,a,b,d,e,f]};s.AdaptOtherCanvas=function(u,l,a,n){var b=a?1:0;var o=s.m_Canvas[1-b];if((a<=1)&&(a>=-2)){var d=l-o.m_nCurrentLOD;var e=Math.pow(2,-d);var p=Math.max(1,e);var f=o.getPixelLeft(),g=o.getPixelTop();var h=o.getPixelWidth(),i=o.getPixelHeight();var j=h/s.m_nWidthCanvas;var k=[(this.m_MapManager.m_tileWidth*o.m_nCurrentX+(s.m_nDivWidth/2-f)/j),(this.m_MapManager.m_tileHeight*o.m_nCurrentY+(s.m_nDivHeight/2-g)/j)];var q=[k[0]-e*u[0],k[1]-e*u[1]];if((Math.abs(q[0])<p*s.m_nWidthCanvas)&&(Math.abs(q[1])<p*s.m_nHeightCanvas)){var r=Math.pow(2,n);var v=r*(f-s.m_nDivWidth/2+j*q[0])+s.m_nDivWidth/2;var w=r*(g-s.m_nDivHeight/2+j*q[1])+s.m_nDivHeight/2;this.MoveCanvas(o,v,w,h*r,i*r);return b}}var x=s.m_Canvas[0].getContext("2d");x.clearRect(0,0,s.m_Canvas[0].width,s.m_Canvas[0].height);return 0};s.ZoomToGeoPosition=function(l,a,d){if(s.m_Canvas[3].m_bCanvasValid){s.SwitchTmpCanvasToActive()}var b=s.m_Canvas[0];var o=b.m_nExactLOD;var n=s.m_MapManager.m_tileWidth;var e=s.m_MapManager.m_tileHeight;var f=Math.min(Math.max(a,s.GetMinLOD()),s.GetMaxLOD());a=Math.floor(f);var g=Math.pow(2,f-a);var h=(1<<a);var u=[h*n,h*e];s.m_Proj.LonLatToUCS(l,u);var i=[u[0]-s.m_nDivWidth/2,u[1]-s.m_nDivHeight/2];var j=s.m_Proj.m_nUCSMin*h;nTargetCanvas=s.AdaptOtherCanvas(u,a,a-b.m_nCurrentLOD,f-b.m_nExactLOD);var k=Math.round(i[0]/n-s.m_nCanvasStdXPos-j);var p=Math.round(i[1]/e-s.m_nCanvasStdYPos);var q=-Math.floor(i[0]-(k+j)*n);var r=-Math.floor(i[1]-p*e);var v=Math.round(q+((g-1)*(q-s.m_nDivWidth/2)));var w=Math.round(r+((g-1)*(r-s.m_nDivHeight/2)));var x=Math.round(s.m_nWidthCanvas*g);var y=Math.round(s.m_nHeightCanvas*g);var z=[h,h];var A=[h,h];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,z);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,A);var B=y/s.m_nHeightCanvas;var C=e*(p-z[1])*B-w;var D=e*(p-A[1])*B+s.m_nDivHeight-w;var T=true;if(C<-s.m_nMaxPixelBeyondPoles)w=e*(p-z[1])*B+s.m_nMaxPixelBeyondPoles;else if(D>s.m_nMaxPixelBeyondPoles)w=e*(p-A[1])*B+s.m_nDivHeight-s.m_nMaxPixelBeyondPoles;else T=false;if(T){if(d)return false;var E=(w+(g-1)*s.m_nDivHeight/2)/g;var F=-Math.round(s.m_nCanvasStdYPos+E/e);p+=F;w+=g*F*e}if(s.m_bXBorderExists){var G=n*(k-z[0])*B-v;var H=n*(k-A[0])*B+s.m_nDivWidth-v;var L=true;if(G<-s.m_nMaxPixelBeyondPoles)v=n*(k-z[0])*B+s.m_nMaxPixelBeyondPoles;else if(H>s.m_nMaxPixelBeyondPoles)v=n*(k-A[0])*B+s.m_nDivWidth-s.m_nMaxPixelBeyondPoles;else L=false;if(L){if(d)return false;var I=(v+(g-1)*s.m_nDivWidth/2)/g;var F=-Math.round(s.m_nCanvasStdXPos+I/e);k+=F;v+=g*F*n}}if((b.m_nCurrentX==k)&&(b.m_nCurrentY==p)&&(b.m_nCurrentLOD==a)){s.MoveCanvas(b,v,w,x,y);b.m_nExactLOD=f}else{s.InvalidateCanvas(s.m_Canvas[1]);var J=s.m_Canvas[nTargetCanvas];s.MoveCanvas(J,v,w,x,y);s.m_MapManager.RequestTiles(J,s.m_MapLayerStack,k,p,s.m_nTilesX,s.m_nTilesY,0,0,0,0,a,false);J.m_nExactLOD=f;if(nTargetCanvas==1)s.ToggleCanvas(s)}s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false);s.InternalOnMoveLayer(b);if(f!=o)s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex]);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(f)}s.m_LastDefinedCenterPos=l;return true};s.SetMapLayerStack=function(n){var i=VBI.GetMapLayerStack(n);if(i==null)return;if(s.m_Canvas[3].m_bCanvasValid){s.SwitchTmpCanvasToActive()}s.m_MapLayerStack=i;var a=s.m_Canvas[0];s.m_MapManager.RequestTiles(a,s.m_MapLayerStack,a.m_nCurrentX,a.m_nCurrentY,s.m_nTilesX,s.m_nTilesY,0,0,0,0,a.m_nCurrentLOD,false);s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false)};s.ZoomToZoomlevel=function(l,n){var r=s.m_Div.getBoundingClientRect();if((r.width!=s.m_nDivWidth)||(r.height!=s.m_nDivHeight))s.resizeCanvas(0);s.ZoomToGeoPosition(l,n)};s.GetMapLayerStack=function(){return s.m_MapLayerStack};s.GetMinLOD=function(){var n=Math.max(s.m_nDivWidth/(s.m_MapManager.m_tileWidth*s.m_nXSizeVisualBorder),s.m_nDivHeight/(s.m_MapManager.m_tileHeight*s.m_nYSizeVisualBorder));var a=Math.log(n)*Math.LOG2E;var b=s.m_MapLayerStack;var d=Math.max(s.m_nMinLodVisualBorder,b?b.GetMinLOD():0)-s.m_nOffsetMinLod;return Math.max(a,d)};s.GetMinLODForWidth=function(w){var n=w/s.m_MapManager.m_tileWidth;var a=Math.log(n)*Math.LOG2E;var b=s.m_MapLayerStack;var d=Math.max(s.m_nMinLodVisualBorder,b?b.GetMinLOD():0)-s.m_nOffsetMinLod;return Math.max(a,d)};s.GetMaxLOD=function(){var a=s.m_MapLayerStack;return Math.min(a?a.GetMaxLOD():20,s.m_nMaxLodVisualBorder)};s.GetCurrentZoomlevel=function(){return s.m_Canvas[0].m_nExactLOD};s.GetCenterPos=function(){if(s.m_LastDefinedCenterPos!=undefined){return s.m_LastDefinedCenterPos}var a=s.getCanvas();var p=[s.m_nDivWidth/2-a.getPixelLeft(),s.m_nDivHeight/2-a.getPixelTop()];return(s.GetGeoFromPoint(p))};s.InternalRenderVisualObjects=function(a,d){var v=s.m_VOS;for(var n=0,l=v.length;n<l;++n)v[n].Render(a,d);if(s.m_DesignVO)s.m_DesignVO.Render(a,d)};s.InternalRenderLayer=function(a,C){s.m_OverlayImageData=null;var o=a.getPixelWidth();var b=a.getPixelHeight();a.setPixelWidth(s.m_nWidthCanvas);a.setPixelHeight(s.m_nHeightCanvas);s.m_ZoomFactors[0]=o/s.m_nWidthCanvas;s.m_ZoomFactors[1]=b/s.m_nHeightCanvas;var d=a.getContext('2d');if(C){d.clearRect(0,0,a.width,a.height);a.setPixelWidth(o);a.setPixelHeight(b);return}d.clearRect(0,0,a.width,a.height);s.InternalRenderVisualObjects(a,d);a.setPixelWidth(o);a.setPixelHeight(b);s.InternalOnRenderLayer(a)};s.InternalOnMoveLayer=function(a){s.m_Ctx.m_Windows.NotifySceneMove(this);var b;if(b=s.m_Ctx.m_Actions){var d;if(d=b.findAction("CenterChanged",s,"Map")){var e=s.m_Canvas[s.m_nOverlayIndex];var n=e.getPixelWidth();var f=e.getPixelHeight();var l=s.GetPosFromPoint([0,0]);var r=s.GetPosFromPoint([n,f]);if(!s.m_Proj.m_bIsIsogonal){var g=s.GetPosFromPoint([n,0]);var h=s.GetPosFromPoint([0,f]);l=[Math.min(l[0],h[0]),Math.min(l[1],g[1])];r=[Math.max(g[0],r[0]),Math.max(h[1],r[1])]}var p={level:s.GetCurrentZoomlevel().toString(),min:l[0].toString()+";"+l[1].toString()+";0",max:r[0].toString()+";"+r[1].toString()+";0",};s.m_Ctx.FireAction(d,s,this,null,p)}}s.m_Ctx.onMoveLayer(a)};s.InternalOnZoomLayer=function(a){s.m_Ctx.m_Windows.NotifySceneZoom(this);var b;if(b=s.m_Ctx.m_Actions){var d;if(d=b.findAction("ZoomChanged",s,"Map")){var e=s.m_Canvas[s.m_nOverlayIndex];var n=e.getPixelWidth();var f=e.getPixelHeight();var l=s.GetPosFromPoint([0,0]);var r=s.GetPosFromPoint([n,0]);var g=s.GetPosFromPoint([0,f]);var h=s.GetPosFromPoint([n,f]);var p={level:s.GetCurrentZoomlevel().toString(),min:Math.min(l[0],g[0]).toString()+";"+Math.min(l[1],r[1]).toString()+";0",max:Math.max(h[0],r[0]).toString()+";"+Math.max(g[1],h[1]).toString()+";0",};s.m_Ctx.FireAction(d,s,this,null,p)}}s.m_Ctx.onZoomLayer(a)};s.InternalOnRenderLayer=function(a){s.m_Ctx.onRenderLayer(a);if(s.GetHomeLocation){var o=a.getPixelWidth();var b=a.getPixelHeight();var l=[0,0];var h=s.GetHomeLocation();l[0]=h[0];l[1]=h[1];var x=s.GetPointFromGeo(l);a.setPixelWidth(s.m_nWidthCanvas);a.setPixelHeight(s.m_nHeightCanvas);var d=a.getContext('2d');d.clearRect(0,0,a.width,a.height);d.fillStyle='yellow';d.beginPath();d.arc(x[0],x[1],5,0,Math.PI*2,true);d.closePath();d.fill();var i=null;if(s.m_Ctx)i=s.m_Ctx.GetImage("dummy",s.RenderAsync.bind(s));if(i)d.drawImage(i,x[0]-i.naturalWidth/2,x[1]-i.naturalHeight);a.setPixelWidth(o);a.setPixelHeight(b)}};s.MoveObject=function(o,x,y,w,h){o.style.left=x.toString()+"px";o.style.top=y.toString()+"px";if(w!==undefined)o.style.width=w.toString()+"px";if(h!==undefined)o.style.height=h.toString()+"px"};s.InvalidateCanvas=function(a){var b=a.getContext("2d");b.fillStyle='white';b.clearRect(0,0,a.width,a.height);a.m_bInvalid=true};s.MoveCanvas=function(a,x,y,w,h){s.MoveObject(s.m_Canvas[s.m_nOverlayIndex],x,y,w,h);s.MoveObject(a,x,y,w,h)};s.MoveOnlyThisCanvas=function(a,x,y,w,h){s.MoveObject(a,x,y,w,h)};s.MoveMap=function(d,a){VBI.m_bTrace&&VBI.Trace("MoveMap"+" DX:"+d+" DY:"+a);var b=s.m_Canvas[3];var e=s.m_Canvas[0];var f=(b.m_bCanvasValid?b:e);var g=s.m_MapManager;var n=f.getPixelWidth();var h=f.getPixelHeight();var i=f.getPixelLeft()+d;var j=f.getPixelTop()+a;var k=s.m_nWidthCanvas,l=s.m_nHeightCanvas;var o=g.m_tileWidth,p=g.m_tileHeight;var q=n/s.m_nTilesX;var r=h/s.m_nTilesY;var u=h/l;var v=(1<<e.m_nCurrentLOD);var w=[v,v];var x=[v,v];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,w);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,x);if((a>0&&((p*u*(f.m_nCurrentY-w[1])-j)<-s.m_nMaxPixelBeyondPoles))||(a<0&&((p*u*(f.m_nCurrentY-x[1])+s.m_nDivHeight-j)>s.m_nMaxPixelBeyondPoles))){if(d==0)return;a=0;j=f.getPixelTop()}if(s.m_bXBorderExists&&((d>0&&((o*u*(f.m_nCurrentX-w[0])-i)<-s.m_nMaxPixelBeyondPoles))||(d<0&&((o*u*(f.m_nCurrentX-x[0])+s.m_nDivWidth-i)>s.m_nMaxPixelBeyondPoles)))){if(a==0)return;d=0;i=f.getPixelLeft()}var y=0;var z=0;var A;if((d>0)&&(A=i+s.m_nMapMoveXPreLoad)>0){y=Math.ceil(A/q)}else if((d<0)&&((A=s.m_nMapMoveXPreLoad+s.m_nDivWidth-(i+n))>0)){y=-Math.ceil(A/q)}var B=f.m_nCurrentX-y;if((a>0)&&(A=j+s.m_nMapMoveYPreLoad)>0){z=Math.ceil(A/r)}else if((a<0)&&(A=(s.m_nMapMoveYPreLoad+s.m_nDivHeight-(j+h)))>0){z=-Math.ceil(A/r)}var C=f.m_nCurrentY-z;var D=s.m_MapLayerStack;var S=D?D.m_bSingleBMP:false;if(y||z){var E=nPendingOffsetY=0;if(!s.m_Canvas[1].m_bInvalid){s.InvalidateCanvas(s.m_Canvas[1])}s.MoveCanvas(e,e.getPixelLeft()+d,e.getPixelTop()+a);if(b.m_bCanvasValid){if(b.m_nTilesBefSwitch<b.m_nForceSwitchLimit){s.SwitchTmpCanvasToActive()}else{E=b.m_nOffsetX;nPendingOffsetY=b.m_nOffsetY}}b.m_nTilesBefSwitch=(S||Math.abs(y)>=s.m_nTilesX||Math.abs(z)>=s.m_nTilesY)?1:(s.m_nTilesX-Math.abs(y))*(s.m_nTilesY-Math.abs(z));b.m_nForceSwitchLimit=Math.ceil(b.m_nTilesBefSwitch/2);b.m_nOffsetX=y+E;b.m_nOffsetY=z+nPendingOffsetY;s.MoveOnlyThisCanvas(b,i-y*q,j-z*r);var F=b.getContext("2d");F.clearRect(0,0,e.getPixelWidth(),e.getPixelHeight());g.RequestTiles(b,s.m_MapLayerStack,B,C,s.m_nTilesX,s.m_nTilesY,0,0,0,0,e.m_nCurrentLOD,false);b.m_bCanvasValid=true;s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false)}else{s.MoveCanvas(e,e.getPixelLeft()+d,e.getPixelTop()+a);s.MoveObject(s.m_Canvas[1],s.m_Canvas[1].getPixelLeft()+d,s.m_Canvas[1].getPixelTop()+a);if(b.m_bCanvasValid)s.MoveOnlyThisCanvas(b,i,j)}s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex]);s.m_LastDefinedCenterPos=undefined};s.AdaptZoomFactor=function(a,f,x,y,b){var r={};r.bZoomNotPossible=true;var n=(1<<a.m_nCurrentLOD);if((a.m_nCurrentY<0)&&(y<-a.m_nCurrentY*(a.getPixelHeight()/s.m_nTilesY)))return r;if(((a.m_nCurrentY+s.m_nTilesY)>n)&&(y>(n-a.m_nCurrentY)*(a.getPixelHeight()/s.m_nTilesY)))return r;if(f<1){var d=Math.max((s.m_nDivWidth/(a.getPixelWidth()*s.m_nXSizeVisualBorder))*(s.m_nTilesX/n),(s.m_nDivHeight/(a.getPixelHeight()*s.m_nYSizeVisualBorder))*(s.m_nTilesY/n));if(f<d){if((d>=1)&&(f!=0))return r;f=d;A=false}}var A=b&&(s.m_nZoomMode||(f==s.m_nLodFactorZoomIn)||(f==s.m_nLodFactorZoomOut));var e=a.m_nExactLOD+Math.log(f)*Math.LOG2E;var g=s.GetMinLOD();if(Math.round(b*e)==Math.round(b*g))A=false;if(A&&Math.round(b*e)!=b*e){e=Math.round(b*e)/b;f=Math.pow(2,e-a.m_nExactLOD)}r.factor=f;r.nNewLod=Math.floor(e);r.lodFallsOnInteger=(Math.round(e)==e);r.bZoomNotPossible=((e>s.GetMaxLOD())||(e<g));return r};s.ZoomMap=function(f,x,y,a){if(s.m_Canvas[3].m_bCanvasValid){s.SwitchTmpCanvasToActive()}var b=s.m_Canvas[0];var o=s.m_Canvas[1];var d=s.m_MapManager;var e=d.m_tileWidth,g=d.m_tileHeight;var n,h,i=0,j=0;var k=b.getPixelLeft(),l=b.getPixelTop();var p=b.getPixelWidth(),q=b.getPixelHeight();var r=o.getPixelWidth();var z=s.AdaptZoomFactor(b,f,x,y,a);if(z.bZoomNotPossible)return;f=z.factor;var u=z.nNewLod;VBI.m_bTrace&&VBI.Trace("Zoom by "+f+" to "+x+"/"+y);if(VBI.m_bIsMobile)s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],true);var v=Math.round(p*f);var w=Math.round(q*f);var A=Math.round(k-((f-1)*x));var B=Math.round(l-((f-1)*y));if(f<1){var C=(1<<b.m_nCurrentLOD);var D=[C,C];var E=[C,C];s.m_Proj.LonLatToUCS(s.m_nBorderMinPoint,D);s.m_Proj.LonLatToUCS(s.m_nBorderMaxPoint,E);var F=w/s.m_nHeightCanvas;var G=(b.m_nCurrentY-D[1])*g*F-B;if(G<-s.m_nMaxPixelBeyondPoles){B=Math.round(g*(b.m_nCurrentY-D[1])*F+s.m_nMaxPixelBeyondPoles);y=(l-B)/(f-1)}else{var H=g*(b.m_nCurrentY-E[1])*F+s.m_nDivHeight-B;if(H>s.m_nMaxPixelBeyondPoles){B=Math.round(g*(b.m_nCurrentY-E[1])*F+s.m_nDivHeight-s.m_nMaxPixelBeyondPoles);y=(l-B)/(f-1)}}if(s.m_bXBorderExists){var I=(b.m_nCurrentX-D[0])*e*F-A;if(I<-s.m_nMaxPixelBeyondPoles){A=Math.round(e*(b.m_nCurrentX-D[0])*F+s.m_nMaxPixelBeyondPoles);y=(k-A)/(f-1)}var J=(b.m_nCurrentX-E[0])*e*F+s.m_nDivWidth-A;if(J>s.m_nMaxPixelBeyondPoles){A=Math.round(e*(b.m_nCurrentX-E[0])*F+s.m_nDivWidth-s.m_nMaxPixelBeyondPoles);y=(k-A)/(f-1)}}}s.MoveCanvas(b,A,B,v,w);var K=v/s.m_nTilesX;var L=w/s.m_nTilesY;var R=false;if(u==b.m_nCurrentLOD){if(!o.m_bInvalid){var M=Math.round(r*f);var N=Math.round(o.getPixelHeight()*f);if((M<=s.m_nMaxCanvasDimension)&&(N<=s.m_nMaxCanvasDimension)){var O=o.getPixelLeft();var P=o.getPixelTop();var Q=Math.round(O-((f-1)*(x+k-O)));var S=Math.round(P-((f-1)*(y+l-P)));s.MoveObject(o,Q,S,Math.round(r*f),Math.round(o.getPixelHeight()*f))}else{s.InvalidateCanvas(s.m_Canvas[1])}}b.m_nExactLOD=b.m_nCurrentLOD+Math.log(K/e)*Math.LOG2E;if(A>0||B>0||(A+v<s.m_nDivWidth)||(B+w<s.m_nDivHeight)){R=true;n=-Math.ceil(A/K);h=-Math.ceil(B/L);i=A+n*K;j=B+h*L;A=b.m_nCurrentX+n;B=b.m_nCurrentY+h;VBI.m_bTrace&&VBI.Trace("run out viewport newTop="+B+" nTilesY="+h+" nPosY="+j+" yOffset="+y+"\n")}}else{R=true;var T=Math.pow(2,b.m_nCurrentLOD-u);var U=x+T*(s.m_nDivWidth/2-k-x);var V=y+T*(s.m_nDivHeight/2-l-y);if(u>b.m_nCurrentLOD){n=Math.round(U/T/(p/s.m_nTilesX)-s.m_nTilesX/2);h=Math.round(V/T/(q/s.m_nTilesY)-s.m_nTilesY/2);i=Math.ceil(A+n*K*T);j=Math.ceil(B+h*L*T)}else{var W=((b.m_nCurrentX%T)+T)%T;var X=((b.m_nCurrentY%T)+T)%T;n=Math.round((U/(p/s.m_nTilesX)+W)/T-s.m_nTilesX/2);h=Math.round((V/(q/s.m_nTilesY)+X)/T-s.m_nTilesY/2);i=A+K*(n*T-W);j=B+L*(h*T-X)}A=Math.floor(b.m_nCurrentX/T+n);B=Math.floor(b.m_nCurrentY/T+h);v=z.lodFallsOnInteger?(e*s.m_nTilesX):Math.ceil(v*T);w=z.lodFallsOnInteger?(g*s.m_nTilesY):Math.ceil(w*T)}if(R){o.m_nExactLOD=u+Math.log(v/s.m_nWidthCanvas)*Math.LOG2E;s.MoveCanvas(o,i,j,v,w);var Y=o.getContext("2d");Y.fillStyle='white';Y.clearRect(0,0,Y.canvas.width,Y.canvas.height);s.m_MapManager.RequestTiles(s.m_Canvas[1],s.m_MapLayerStack,A,B,s.m_nTilesX,s.m_nTilesY,0,0,0,0,u,true);b.m_Scene.ToggleCanvas(b.m_Scene)}if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(u)}if(!VBI.m_bIsMobile)s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false);s.InternalOnMoveLayer(b);s.InternalOnZoomLayer(s.m_Canvas[s.m_nOverlayIndex]);s.m_LastDefinedCenterPos=s.m_LastZoomArea=undefined};s.ZoomOtherCanvas=function(o,a,f,x,y){var n=Math.round(o.getPixelLeft()-((f-1)*x));var b=Math.round(o.getPixelTop()-((f-1)*y));var d=Math.round(o.getPixelWidth()*f);var e=Math.round(o.getPixelHeight()*f);s.MoveObject(o,n,b,d,e)};s.AnimateZoom=function(z,a,b,i,G){var n=s.m_Canvas[0].m_nExactLOD;var d=2*s.m_nTicksInALod;if(s.m_AnimZoomTimer&&(s.m_nAnimDirection==z)){if(s.m_nAnimOpenTicks>40)return;window.clearInterval(s.m_AnimZoomTimer);s.m_nAnimOpenTicks+=d;s.m_nAnimTicks+=d}else{var e=Math.round((n-Math.floor(n))*d);s.m_nAnimTicks=1+(z?d-e:e);if(s.m_nAnimTicks<=5)s.m_nAnimTicks+=d;s.m_nAnimOpenTicks=s.m_nAnimTicks;s.m_nAnimDirection=z;if(s.m_AnimZoomTimer)window.clearInterval(s.m_AnimZoomTimer)}var f=i*d/(s.m_nAnimTicks-1);s.AnimZoomTarget=Math.min(s.GetMaxLOD(),Math.max(s.GetMinLOD(),n+(s.m_nAnimDirection?1:-1)*(s.m_nAnimOpenTicks-1)/d));s.m_AnimZoomTimer=window.setInterval(function(){if(--s.m_nAnimOpenTicks){var r=s.m_Canvas[0].getBoundingClientRect();var o=s.m_Canvas[0].m_nExactLOD;s.ZoomMap(s.m_nAnimDirection?s.m_nLodFactorZoomInHalf:s.m_nLodFactorZoomOutHalf,a-r.left,b-r.top,d);if((s.m_Canvas[0].m_nExactLOD!=o)||(Math.abs(s.AnimZoomTarget-o)>s.m_nMaxAnimLodDiff))return}if(s.m_AnimZoomTimer){s.m_nAnimOpenTicks=s.m_nAnimationTicks=s.m_nAnimationDirection=s.AnimZoomTarget=undefined;window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null;s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false)}},f)};s.AnimateZoomToGeo=function(l,G,i){var n=s.m_Canvas[0].m_nExactLOD;if(n==G)return;var a=2*s.m_nTicksInALod;if(s.m_AnimZoomTimer){window.clearInterval(s.m_AnimZoomTimer)}s.m_nAnimTicks=2+Math.abs(Math.round((n-G)*a));s.m_nAnimOpenTicks=s.m_nAnimTicks;var b=n;var d=G;var e=i*a/s.m_nAnimTicks;s.m_AnimZoomTimer=window.setInterval(function(){if(--s.m_nAnimOpenTicks){var r=s.m_Canvas[0].getBoundingClientRect();s.ZoomToZoomlevel(l,d-(s.m_nAnimOpenTicks-1)*(d-b)/(s.m_nAnimTicks-1),i);return}if(s.m_AnimZoomTimer){s.m_nAnimOpenTicks=s.m_nAnimationTicks=undefined;window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null;s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false)}},e)};s.IsTransparent=function(a,b){var C=s.m_Canvas[s.m_nOverlayIndex];if(!C)return false;var r=C.getBoundingClientRect();var n=Math.round((a-r.left)/s.m_ZoomFactors[0]);var d=Math.round((b-r.top)/s.m_ZoomFactors[1]);if(!s.m_OverlayImageData){var e=C.getContext("2d");s.m_OverlayImageData=e.getImageData(0,0,s.m_nWidthCanvas,s.m_nHeightCanvas).data}var f=(d*s.m_nWidthCanvas+n)*4+3;if((f<0)||(f>=(s.m_nWidthCanvas*s.m_nHeightCanvas*4))){VBI.m_bTrace&&VBI.Trace("GeoScene::IsTransparent coordinate out of bounds");return true}var g=s.m_OverlayImageData[f];return g?false:true};s.GetCurrentZoomFactors=function(){return s.m_ZoomFactors};s.ToggleCanvas=function(s){var a=s.m_Canvas[0];s.m_Canvas[0]=s.m_Canvas[1];s.m_Canvas[1]=a;s.m_Canvas[0].style.opacity=0.0;s.m_Canvas[1].style.opacity=1.0;a=s.m_Canvas[0].style.zIndex;s.m_Canvas[0].style.zIndex=s.m_Canvas[1].style.zIndex;s.m_Canvas[1].style.zIndex=a;s.BlendCanvas()};s.BlendCanvas=function(){if(s.m_BlendTimer!=null)window.clearInterval(s.m_BlendTimer);var n=parseFloat(s.m_Canvas[0].style.opacity);if(n<1.0){s.m_BlendTimer=window.setInterval(s.BlendCanvas,40);s.m_Canvas[0].style.opacity=Math.min(n+0.1,1.0);if(VBI.m_bIsMyChromeTest){s.m_Canvas[0].style.display='none';s.m_Canvas[0].offsetHeight;s.m_Canvas[0].style.display='block'}}else{window.clearInterval(s.m_BlendTimer)}};s.GetNearestPosArray=function(p){var a=p.slice();var n=Math.floor(a.length/3)*3;var b=a[0];var d=a[1];var e=b,f=b;var g=d,h=d;for(var i=3;i<n;i+=3){while(a[i]-b>180)a[i]-=360;while(b-a[i]>180)a[i]+=360;b=a[i];d=a[i+1];if(e>b)e=b;if(f<b)f=b;if(g>d)g=d;if(h<d)h=d}a.m_MinX=e;a.m_MaxX=f;a.m_MinY=g;a.m_MaxY=h;return a};s.GetNearestPos=function(a,n){var p=a.slice();var b=n[0];while(p[0]-b>180)p[0]-=360;while(b-p[0]>180)p[0]+=360;return p};s.GetPointArrayFromPosArray=function(p,a){var l=[0.0,0.0],r=[];var b=s.m_Canvas[0];var n=(1<<b.m_nCurrentLOD);var d=s.m_nWidthCanvas/s.m_nTilesX;var e=s.m_nHeightCanvas/s.m_nTilesY;var f=n*d;var g=n*e;var h=s.m_Canvas[s.m_nOverlayIndex];var i=h.getPixelWidth()/s.m_nWidthCanvas;var j=h.getPixelHeight()/s.m_nHeightCanvas;var k=s.m_Proj.LonLatToUCS;var u=[0,0],o=Math.PI/180.0;var q=s.m_Proj;var v=q.m_nUCSMin*f;var w=q.m_nUCSMax*f;var z=q.m_nXYRatio*f;var A=b.m_nCurrentX*d+v;var B=b.m_nCurrentY*e;for(var C=0,D=p.length/3;C<D;++C){l[0]=o*p[C*3];l[1]=o*p[C*3+1];u[0]=f;u[1]=g;u=k(l,u);u[0]=u[0]-A;u[1]=u[1]-B;if(a){while(u[0]<v)u[0]+=z;while(u[0]>w)u[0]-=z}r.push(u[0]*i,u[1]*j,0.0)}if(C==1&&u){var x,y;r.m_bVisible=(((x=u[0])>0)&&((y=u[1])>0)&&(x<s.m_nWidthCanvas)&&(y<s.m_nHeightCanvas))}return r};s.GetPointFromGeo=function(l,a){return s.GetPointArrayFromPosArray(VBI.MathLib.RadToDeg(l),a)};s.GetInstanceOffsets=function(r){var a=r.slice();var b=s.m_Canvas[0];var d=s.m_nWidthCanvas/s.m_nTilesX;var e=(1<<b.m_nCurrentLOD)*d*s.m_Proj.m_nXYRatio;var f=[0,0,s.m_nWidthCanvas,s.m_nHeightCanvas];var n=0;while(a[2]>0){--n;VBI.Utilities.RectOffset(a,-e,0)}var o=[];while(a[0]<s.m_nWidthCanvas){n++;VBI.Utilities.RectOffset(a,e,0);if(VBI.Utilities.RectIntersect(a,f))o.push(n*e)}return o};s.GetPosFromVPPoint=function(p){var a=s.m_Canvas[s.m_nOverlayIndex];var b=[p[0]-a.getPixelLeft(),p[1]-a.getPixelTop(),0];var d=this.GetGeoFromPoint(b);return VBI.MathLib.RadToDeg(d)};s.GetPosFromPoint=function(p){var a=this.GetGeoFromPoint(p);return VBI.MathLib.RadToDeg(a)};s.GetGeoFromPoint=function(p){var a=s.m_Canvas[0];var n=a.m_nCurrentLOD;var b=(1<<n);var d=p[0]*s.m_nWidthCanvas/a.getPixelWidth();var e=p[1]*s.m_nHeightCanvas/a.getPixelHeight();var f=s.m_nWidthCanvas/s.m_nTilesX;var g=s.m_nHeightCanvas/s.m_nTilesY;var h=a.m_nCurrentX*f;var i=a.m_nCurrentY*g;var j=h+d;var k=i+e;var l=b*f;var o=b*g;var q=[0,0];var u=[j/l*2.0-1.0,k/o*2.0-1.0];return s.m_Proj.UCSToLonLat(u,q)};s.getCanvas=function(){return s.m_Canvas[0]};s.clearTimers=function(){if(s.m_BlendTimer){window.clearInterval(s.m_BlendTimer);s.m_BlendTimer=null}if(s.m_AnimZoomTimer){window.clearInterval(s.m_AnimZoomTimer);s.m_AnimZoomTimer=null}};s.clearCanvases=function(){for(var n=0,a=s.m_Canvas.length;n<a;++n){s.m_Canvas[n].m_Scene=null;s.m_Canvas[n]=null}s.m_Canvas=[]};s.Remove=function(){if(s.m_Div){s.SetInputMode(VBI.InputModeDefault);while(s.m_Div.firstChild)s.m_Div.removeChild(s.m_Div.firstChild);s.m_Div.parentElement.removeChild(s.m_Div);s.m_Div=null;s.clearTimers();s.clearCanvases()}if(s.m_Target){while(s.m_Target.firstChild)s.m_Target.removeChild(s.m_Target.firstChild)}};s.AddCopyright=function(){if(!s.m_MapLayerStack)return;var C=VBI.Utilities.CreateGeoSceneDivCSS(s.m_Target.id+"-copyright","vbi-copyright");s.m_Div.appendChild(C);s.m_DivCopyright=C;var a=s.m_MapLayerStack.GetCopyright();if(a){s.m_DivCopyright.innerHTML=a}else{s.m_DivCopyright.style.paddingRight=0;s.m_DivCopyright.style.paddingLeft=0}};s.Awake=function(t,m,c){if(!(s.m_Target=VBI.Utilities.GetDOMElement(t)))s.m_Target=VBI.Utilities.CreateDOMElement(t,"1px","1px");if(s.m_Div){if(s.m_Div.parentNode==s.m_Target)return;s.m_Target.appendChild(s.m_Div);if(s.m_bNavControlVisible&&s.m_NavControl)s.m_NavControl.AttachEvents();return}s.m_TargetName=t;s.m_MapManager=typeof m!=='undefined'?m:VBI.MapManager;s.m_MapLayerStack=typeof c!=='undefined'?c:s.m_RefMapLayerStack;s.m_Div=VBI.Utilities.CreateGeoSceneDiv(t+"-geoscene");s.m_Target.appendChild(s.m_Div);s.DoAwake(t)};s.setProjection=function(){if(!s.m_RefMapLayerStack||!s.m_RefMapLayerStack.m_MapLayerArray||!s.m_RefMapLayerStack.m_MapLayerArray.length)return new VBI.MercatorProjection;var l=s.m_RefMapLayerStack.m_MapLayerArray;var n=l[0].GetMapProvider().m_nProjection;for(var i=2;i<l.length;++i){if(l[i].GetMapProvider().m_nProjection!=n){VBI.m_bTrace&&VBI.Trace("projection of layer "+i+" is inconsistent to base layer. Choosing projection of base layer")}}switch(n){case 1:return new VBI.MercatorProjection;case 2:return new VBI.LinearProjection;default:return new VBI.MercatorProjection}};s.DoAwake=function(t){s.CalculateCanvasDimensions();s.CreateCanvases();
// append copyright 
s.AddCopyright();var C=s.m_Canvas[s.m_nOverlayIndex];if(s.m_Events)s.m_Events.clear();s.m_Events=new VBI.SceneEvent(this,C);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.Awake(s,t)}var a=s.m_MapLayerStack;if(a&&(a.GetMinLOD()>s.m_startLOD))s.m_startLOD=s.m_MapLayerStack.GetMinLOD();s.GoToInitialStart()};s.CalcCanvasWidth=function(w,a){return(Math.floor(w/a+s.m_nCanvasXOversize))*a};s.CalcCanvasHeight=function(h,a){return(Math.floor(h/a+s.m_nCanvasYOversize))*a};s.CalculateCanvasDimensions=function(){var n=s.m_Target.offsetWidth;var r=s.m_Div.getBoundingClientRect();var a=s.m_MapManager;var d=r.width?r.width:s.m_Div.clientWidth;var b=r.height?r.height:s.m_Div.clientHeight;if((d==s.m_nDivWidth)&&(b==s.m_nDivHeight))return;s.m_nDivWidth=d;s.m_nDivHeight=b;s.m_nWidthCanvas=s.CalcCanvasWidth(d,a.m_tileWidth);s.m_nHeightCanvas=s.CalcCanvasHeight(b,a.m_tileHeight);s.m_nTilesX=s.m_nWidthCanvas/a.m_tileWidth;s.m_nTilesY=s.m_nHeightCanvas/a.m_tileHeight;a.m_requestTileWidth=a.m_tileWidth;a.m_requestTileHeight=a.m_tileHeight;var l=s.m_MapLayerStack;if(l.m_nMaxSquare&&l.m_MapLayerArray.length){var e=0;for(var i=0;i<l.m_MapLayerArray.length;++i){if(!i||(l.m_MapLayerArray[i].m_refMapProvider.m_nResolution<e)){e=parseInt(l.m_MapLayerArray[i].m_refMapProvider.m_nResolution)}}var f=l.m_nMaxSquare*e;if((s.m_nTilesX*a.m_tileWidth>f)||(s.m_nTilesY*a.m_tileHeight>f)){var g=Math.floor(f/Math.max(s.m_nTilesX,s.m_nTilesY));a.m_requestTileWidth=g;a.m_requestTileHeight=g}}VBI.m_bTrace&&VBI.Trace("Setting Canvas Size to ("+s.m_nWidthCanvas+","+s.m_nHeightCanvas+") on div with size ("+d+","+b+")");s.m_nMapMoveXPreLoad=Math.min(120,a.m_tileWidth*(s.m_nTilesX-1)-d);s.m_nMapMoveYPreLoad=Math.min(120,a.m_tileHeight*(s.m_nTilesY-1)-b);s.m_nCanvasStdXPos=(s.m_nWidthCanvas-s.m_nDivWidth)/a.m_tileWidth/2;s.m_nCanvasStdYPos=(s.m_nHeightCanvas-s.m_nDivHeight)/a.m_tileHeight/2;if(s.m_bXBorderExists||s.m_bXBorderExists)s.m_nMaxPixelBeyondPoles=0;else{s.m_nMaxPixelBeyondPoles=b/4;if(b>d)s.m_nMaxPixelBeyondPoles+=(b-d)/2}};s.SwitchTmpCanvasToActive=function(){var d=s.m_Canvas[0],a=s.m_Canvas[3];var b=d.getContext('2d');b.clearRect(0,0,d.getPixelWidth(),d.getPixelHeight());b.drawImage(s.m_Canvas[3],0,0);s.MoveCanvas(d,d.getPixelLeft()-a.m_nOffsetX*d.getPixelWidth()/s.m_nTilesX,d.getPixelTop()-a.m_nOffsetY*d.getPixelHeight()/s.m_nTilesY);d.m_nCurrentX=a.m_nCurrentX;d.m_nCurrentY=a.m_nCurrentY;a.m_bCanvasValid=false;a.m_CanvasRedirect=d;a.m_CanvasRedirRequest=a.m_nRequest;a.m_nOffsetX=a.m_nOffsetY=0;a.m_nTilesBefSwitch=undefined;s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false)};s.CreateCanvases=function(){var i=s.m_TargetName+"-"+s.m_ID+"-";s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"layer1",s.m_nWidthCanvas,s.m_nHeightCanvas,2));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"layer2",s.m_nWidthCanvas,s.m_nHeightCanvas,1));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"objectlayer",s.m_nWidthCanvas,s.m_nHeightCanvas,3,0));s.m_Canvas.push(VBI.Utilities.CreateGeoSceneCanvas(i+"nondomlayer",s.m_nWidthCanvas,s.m_nHeightCanvas,4,0,true));for(var n=0;n<s.m_Canvas.length;++n){s.m_Canvas[n].m_Scene=s;s.m_Canvas[n].m_nCurrentLOD=2;s.m_Canvas[n].m_nExactLOD=2;s.m_Canvas[n].m_nCurrentX=0;s.m_Canvas[n].m_nCurrentY=0;s.m_Canvas[n].m_nAppliedRequest=0;s.m_Canvas[n].m_bInvalid=false;if(!s.m_Canvas[n].m_bNotInDOM)s.m_Div.appendChild(s.m_Canvas[n])}};s.resizeCanvas=function(e){if(!s.m_Canvas.length){s.DoAwake();return}if(s.m_Canvas[3].m_bCanvasValid)s.SwitchTmpCanvasToActive();var a=s.m_MapManager;var b=s.m_Canvas[0];var o=s.m_nDivWidth;var d=s.m_nDivHeight;var f=s.GetMinLODForWidth(o);var g=b.getPixelWidth()/s.m_nWidthCanvas;s.CalculateCanvasDimensions();if((s.m_nDivWidth==o)&&(s.m_nDivHeight==d))return;VBI.m_bTrace&&VBI.Trace("Resizing ("+(o)+","+(d)+") to ("+(s.m_nDivWidth)+","+(s.m_nDivHeight)+")");var h=b.m_nCurrentX;var j=b.m_nCurrentY;var l=b.m_nCurrentLOD;var n=b.getPixelLeft()+(s.m_nDivWidth-o)/2;var x=Math.round((-n/a.m_tileWidth-s.m_nCanvasStdXPos)/g);n+=g*x*a.m_tileWidth;var k=b.getPixelTop()+(s.m_nDivHeight-d)/2;var y=Math.round((-k/a.m_tileHeight-s.m_nCanvasStdYPos)/g);k+=g*y*a.m_tileHeight;for(var i=0;i<s.m_Canvas.length;++i){s.m_Canvas[i].width=s.m_nWidthCanvas;s.m_Canvas[i].height=s.m_nHeightCanvas}s.InvalidateCanvas(s.m_Canvas[1]);s.MoveCanvas(b,n,k,g*s.m_nWidthCanvas,g*s.m_nHeightCanvas);s.m_MapManager.RequestTiles(b,s.m_MapLayerStack,h+x,j+y,s.m_nTilesX,s.m_nTilesY,0,0,0,0,l,false);var p=s.m_LastZoomArea;var q=s.GetMinLOD();if(b.m_nExactLOD<q){s.ZoomMap(Math.pow(2,q-b.m_nExactLOD)*1.000001,s.m_nDivWidth/2-n,s.m_nDivHeight/2-k)}else{if(b.m_nExactLOD!=Math.floor(b.m_nExactLOD)){s.AnimateZoomToGeo(s.GetCenterPos(),Math.floor(b.m_nExactLOD),33)}else{s.InternalRenderLayer(s.m_Canvas[s.m_nOverlayIndex],false);s.InternalOnMoveLayer(s.m_Canvas[s.m_nOverlayIndex])}}if((s.GetMinLOD()!=f)&&s.m_NavControl)s.m_NavControl.AdaptMinMaxLOD(s);if(s.m_bNavControlVisible&&s.m_NavControl){s.m_NavControl.AdjustScrollPoint(b.m_nCurrentLOD)}if(p!=undefined){var r=new Date().getTime();if((r-p[0])<3000)s.ZoomToArea(p[1],p[2],p[3],p[4],p[5])}};if(t)s.Awake(t,m,c);return s};
